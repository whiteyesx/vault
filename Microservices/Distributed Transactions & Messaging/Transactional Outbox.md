
# Context | Контекст

Типичная ситуация, что сервису необходимо создавать/удалять/обновлять сообщения и публиковать сообщения об этом.

Например: 
* Сервис который участвует в **saga**, должен обновить сущность и отправить событие.
* Сервис который публикует доменный ивент должен обновить аггрегат и отправить об этом событие.

Команда должна атомарно обновлять базу данных и отправлять событие во избешание  инконсистентности данных. Использовать традиционный 2PC нецелесообразно, база данных или message broker могут его не поддерживать.  

Даже если и поддерживает, то часто нежелательно связывать сервис как с базой данных, так и с message broker. 

Без использования 2PC отправка сообщения в рамках транзакции ненадежна:
* У нас нет гарантии, что транзакция зафиксируется. 
* Если же сервис будет отправлять сообщение после транзакции, то нет гарантии что наше приложение упадет до успешной отправки.

В дополнение, сообщения должны быть отправлены в таком же порядке в котором они были отправлены сервисом. Обычно события должны быть доставлены каждому потребителю в том же порядке, но это выходит за рамки этого шаблона.

## Problem | Проблема

Как атомарно вносить изменения в базу данных и отправлять сообщения в message broker?

## Force | Условия 

* 2PC не является опцией. База данных или message broker не поддерживают 2PC. Часто нежелательно добавлять обе интеграции в один сервис.
* Если транзакция фиксируется должен быть отправлен ивент. В случае отката транзакции, сообщение не должно быть отправлено
* Сообщения должны быть доставлены в порядке, в котором они были отправлены сервисом. Порядок должен сохраняться в рамках нескольких экземпляров сервиса, которые обновляют агрегат.


